<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="/static/manifest.webmanifest">  
  <title>ApiTed Driver ‚Äî Esc√°ner QR</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;padding:16px}
    video{width:100%;max-width:520px;border:1px solid #ddd;border-radius:12px}
    .card{max-width:520px;border:1px solid #eee;border-radius:12px;padding:12px;margin-top:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    input,button,textarea{padding:10px;border:1px solid #ddd;border-radius:8px;flex:1}
    button{cursor:pointer}
    .small{font-size:12px;color:#666}
    .ok{color:#0a0}
    .warn{color:#a60}
  </style>
</head>
<body>
  <h1>üì¶ ApiTed ‚Äî Esc√°ner de QR</h1>
  <p class="small">Tip: en Android, Chrome pide permiso de c√°mara. En PC, funciona en <b>localhost</b> o HTTPS.</p>

  <video id="preview" playsinline></video>

  <div class="card">
    <div class="row">
      <button id="start" type="button">Iniciar c√°mara</button>
      <button id="stop" type="button">Detener</button>
      <button id="flip" type="button">Cambiar c√°mara</button>
    </div>
    <div class="row">
      <input id="last" placeholder="√öltimo QR decodificado" readonly>
    </div>
    <div class="row">
      <input id="shipment" placeholder="shipment_id detectado (si aplica)" readonly>
    </div>
    <div class="row">
      <input id="recipient" placeholder="Destinatario (auto por OCR)" />
    </div>
    <div class="row">
      <input id="address" placeholder="Direcci√≥n (auto por OCR)" />
    </div>
    <div class="row">
      <input id="labelPhoto" type="file" accept="image/*" capture="environment">
      <button id="ocrLabel" type="button">Leer etiqueta (OCR)</button>
    </div>
  
    <div class="row">
      <textarea id="notes" placeholder="Notas (ej. timbre roto, perro, piso 3)"></textarea>
    </div>
    <div class="row">
      <button id="save" type="button">Guardar a lista</button>
      <button id="export" type="button">Exportar CSV</button>
      <span id="status" class="small"></span>
    </div>
  </div>

  <div class="card">
    <h3>üóÇ Lista de env√≠os del d√≠a</h3>
    <table id="tbl" border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;width:100%">
      <thead>
        <tr>
          <th>#</th>
          <th>ID</th>
          <th>shipment_id</th>
          <th>Destinatario</th>
          <th>Direcci√≥n</th>
          <th>QR crudo</th>
          <th>QR (raw)</th>
          <th>Notas</th>
          <th>Hora</th>
        </tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
  </div>

  <!-- Librer√≠a de QR (via CDN) -->
  <script type="module">
          
    // === Diagn√≥stico r√°pido ===
    const ids = ["btnStart","btnStop","btnSwitch","btnSave","btnExport","ocrLabel"];
    function byId(id){ const el = document.getElementById(id); if(!el) console.error("No existe #"+id); return el; }
    try {
      console.log("‚úÖ JS cargado. Version diag 1");
      ids.forEach(id => {
         const b = byId(id);
         if (b) {
           b.addEventListener("click", () => {
             console.log("click ->", id);
             b.textContent = "‚úî " + b.textContent; // marca visual al clic
             setTimeout(() => (b.textContent = b.textContent.replace(/^‚úî\s*/,"")), 600);
           }, { once: false });
         }
       });
     } catch (e) {
       alert("‚ùå Error inicial de JS: " + (e?.message||e));
       console.error(e);
     }
      // === /Diagn√≥stico¬†===



    import Tesseract from "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";
    const video = document.getElementById('preview');
    const btnStart = document.getElementById('start');
    const btnStop = document.getElementById('stop');
    const btnFlip = document.getElementById('flip');
    const btnSave = document.getElementById('save');
    const btnExport = document.getElementById('export');
    const last = document.getElementById('last');
    const shipment = document.getElementById('shipment');
    const notes = document.getElementById('notes');
    const status = document.getElementById('status');
    const tbody = document.querySelector('#tbl tbody');

    // C√≤digo OCR
    const recipient = document.getElementById('recipient');
    const address = document.getElementById('address');
    const labelPhoto = document.getElementById('labelPhoto');
    const ocrBtn = document.getElementById('ocrLabel');

  // Heur√≠sticas b√°sicas para espa√±ol (ajustables)
  function parseRecipient(text) {
    // Busca l√≠neas con "Destinatario", o la 1¬™ l√≠nea en may√∫sculas con 2+ palabras
    const byWord = /destinatario[:\s]*([^\n]+)/i.exec(text);
    if (byWord) return byWord[1].trim();
    const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
    const cand = lines.find(l => /[A-Z√Å√â√ç√ì√ö√ë]{3,}\s+[A-Z√Å√â√ç√ì√ö√ë]{3,}/.test(l));
    return cand || "";
  }
  function parseAddress(text) {
    // Calle + n√∫mero + opcional piso/depto ‚Äî muy ajustable a tus etiquetas
    const byCalleNum = /([A-Z√Å√â√ç√ì√ö√ëa-z√°√©√≠√≥√∫√±\s\.]{3,})\s+(\d{1,6})(.*)?/m.exec(text);
    if (byCalleNum) {
      const calle = byCalleNum[1].replace(/\s{2,}/g,' ').trim();
      const num = byCalleNum[2].trim();
      const resto = (byCalleNum[3]||"").trim();
      // recort√° resto a algo razonable (piso, dto, localidad)
      const extra = resto.split(/[,;]/)[0].slice(0,40).trim();
      return `${calle} ${num}${extra ? ' ' + extra : ''}`.trim();
    }
    return"";
  }
// ---------- cierre Codigo ocr---------
    let scanner;
    let currentDeviceId = null;
    let rows = [];

    function parseShipmentId(text) {
      // üß™ Ac√° probamos algunos patrones comunes.
      // Si el QR trae una URL con "shipments" o "shipment_id=", extraemos.
      const byParam = /(?:shipment_id=|shipping_id=)(\d+)/i.exec(text);
      if (byParam) return byParam[1];
      const byWord = /shipments?\/(\d+)/i.exec(text);
      if (byWord) return byWord[1];
      const onlyDigits = text.match(/\b\d{8,15}\b/); // n√∫mero largo en el texto
      if (onlyDigits) return onlyDigits[0];
      return "";
    }

    async function listCameras() {
      const devices = await QrScanner.listCameras(true);
      return devices;
    }

    async function start(deviceId = null) {
      if (scanner) await scanner.stop();
      scanner = new QrScanner(video, result => {
        last.value = result.data.trim();
        shipment.value = parseShipmentId(result.data.trim());
        status.textContent = 'QR le√≠do';
        status.className = 'small ok';
      }, { preferredCamera: deviceId ? { deviceId } : 'environment' });
      await scanner.start();
    }
      //botones
    btnStart.onclick = async () => {
      status.textContent = 'Abriendo c√°mara...';
      status.className = 'small';
      await start(currentDeviceId);
      status.textContent = 'C√°mara lista';
      status.className = 'small ok';
    };
    ocrBtn.onclick = async () => {
      const f = labelPhoto.files?.[0];
      if (!f) { msgStatus('Eleg√≠ una foto de la etiqueta', 'small warn'); return; }
      msgStatus('Leyendo etiqueta (OCR)‚Ä¶');
        try {
      const res = await Tesseract.recognize(f, 'spa+eng', { logger: () => {} });
      const text = (res?.data?.text || '').replace(/\r/g,'').trim();
      const r = parseRecipient(text);
      const a = parseAddress(text);
      if (r) recipient.value = r;
      if (a) address.value = a;
      if (!r && !a) msgStatus('No pude detectar nombre/direcci√≥n. Prob√° otra foto o acerc√° m√°s.', 'small warn');
      else msgStatus('Etiqueta le√≠da por OCR', 'small ok');
      } catch (e) {
      msgStatus('Error de OCR. Prob√° con otra foto (m√°s foco y luz).', 'small¬†warn');
      }
    };
    btnStop.onclick = async () => {
      if (scanner) await scanner.stop();
      status.textContent = 'C√°mara detenida';
      status.className = 'small warn';
    };

    btnFlip.onclick = async () => {
      const cams = await listCameras();
      if (!cams.length) return;
      const idx = cams.findIndex(c => c.deviceId === currentDeviceId);
      const next = cams[(idx + 1) % cams.length];
      currentDeviceId = next.deviceId;
      await start(currentDeviceId);
      status.textContent = 'C√°mara cambiada';
    };

    btnSave.onclick = () => {
      if (!last.value) {
        status.textContent = 'Escane√° un QR primero';
        status.className = 'small warn';
        return;
      }
      const row = {
        shipment_id: shipment.value || '',
        raw_qr: last.value,
        recipient: recipient.value || '',
        address: address.value || '',
        notes: notes.value || '',
        ts: new Date().toISOString()
      };
      rows.push(row);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${rows.length}</td>
                      <td>${row.shipment_id}</td>
                      <td>${row.raw_qr}</td>
                      <td>${row.recipient}</td>
                      <td>${row.address}</td>
                      <td>${row.notes}</td>
                      <td>${new Date(row.ts).toLocaleTimeString()}</td>`;
      tbody.prepend(tr);
      notes.value = '';
      status.textContent = 'Guardado en la lista';
      status.className = 'small ok';
    };

    btnExport.onclick = () => {
      if (!rows.length) return;
      const header = ['shipment_id','recipient','raw_qr','address','notes','ts'];
      const csv = [header.join(',')]
        .concat(rows.map(r => header.map(h => `${String(r[h]||'').replace(/"/g,'""')}"`).join(',')))
        .join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = `apited_envios_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    };
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
      .register("/sw.js")
      .then(() => console.log(" Service Worker registrado"))
      .catch((err) => console.error( "ERROR en SW:", err));
    }
  </script>
</body>
</html>